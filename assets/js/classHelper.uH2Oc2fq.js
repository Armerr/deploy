import e from"./GroupList.ulb_CDbe.js";import s from"./RollCall.yTDEHgIq.js";import o from"./GroupRanking.lSvLJxp6.js";import r from"./StudentRanking.EzFfwISs.js";import{s as t,a as n,h as d,b as u,c,g as i}from"./class.Jt5_Tb-s.js";import{r as a,t as l,o as p,b as v,c as f,d as g,e as S,W as m,m as I}from"./vendor.xaFdOCnE.js";import{_ as j,U as h,s as y}from"./index.Dnl5OJ5X.js";import"./StudentInfo.PkXdBpfd.js";import"./ContentRoller.NAH7VU0K.js";import"./StudentRoller.MR5a3koc.js";import"./ScoreModal._UVx8kAn.js";import"./http.PeGqulen.js";import"./confirm.DugmkCAa.js";const b={class:"container"},G={class:"left-container"},R={class:"right-container"},E=j({__name:"classHelper",setup(j){const E=a([]),_=a(""),A=m(),w={},C=a({}),M=a(!0),k=l((()=>[...E.value].sort(((e,s)=>s.score-e.score)))),x=l((()=>E.value.flatMap((e=>e.students.map((s=>({...s,groupId:e.id})))))));function L(e){if(!e)return;const s=e.groupId,o=e.studentId,r=E.value.find((e=>e.id===s));if(!r)return;const t=r.students.find((e=>e.id===o));t&&(t.editScore=t.score,t.editingScore=!0)}async function V(e){var s;if(!e)return;const o=e.groupId,r=e.studentId,n=e.newScore,d=E.value.find((e=>e.id===o));if(!d)return;const u=d.students.find((e=>e.id===r));if(!u)return;if(void 0===n||n===u.score)return u.editingScore=!1,void(u.editScore=void 0);const c=u.score;u.score=n,u.editingScore=!1;try{const e=n-c,o={};o.userId=null!=(s=y.get(h))?s:"";t(o,{studentId:r,score:n}).then((()=>{d.score+=e,I.success("分数修改成功")}))}catch(i){u.score=c,I.error("分数修改失败，请重试")}finally{u.editingScore=!1,u.editScore=void 0}}const q=e=>{var s;if(e.groupId&&e.studentId){const o={};o.classId=_.value,o.groupId=e.groupId,o.studentId=e.studentId;const r={};r.userId=null!=(s=y.get(h))?s:"",n(r,o).then((()=>{O(),I.success("设置成功")}))}},H=e=>{F(e,1)},U=e=>{F(e,-1)},W=e=>{B(e,1)},z=e=>{B(e,-1)},B=(e,s)=>{const o=E.value.find((s=>s.id===e));if(!o)return;const r={};r.classId=_.value,r.groupId=e,r.score=s,d(r).then((()=>{o.score+=s}))},D=new Map,F=async(e,s)=>{const o=E.value.find((s=>s.id===e));if(!o)return;const r=Symbol(),t={groupVersion:o.version||0,originalGroupScore:o.score,students:o.students.map((e=>({id:e.id,originalScore:e.score,version:e.version||0}))),controllers:[]};D.set(r,t);try{o.version=(o.version||0)+1,o.students.forEach((e=>{e.version=(e.version||0)+1,e.score=e.score+s})),o.score=o.students.reduce(((e,s)=>e+s.score),0);const e={};e.classId=_.value,e.groupId=o.id,e.score=s,u(e).then((()=>{}),(()=>{o.score=t.originalGroupScore,o.version=t.groupVersion,o.students.forEach((e=>{const s=t.students.find((s=>s.id===e.id));e.score=s.originalScore,e.version=s.version})),o.score=o.students.reduce(((e,s)=>e+s.score),0),I.error("操作失败，已恢复数据")}))}finally{D.delete(r)}},J=e=>{N(e,1)},K=e=>{N(e,-1)},N=async(e,s)=>{w[e]&&w[e].abort();const o=new AbortController;let r,t,n;w[e]=o;try{C.value[e]=!0,r=E.value.find((s=>s.students.some((s=>s.id===e)))),t=r.students.find((s=>s.id===e)),n=t.score;const o=n+s;t.score=o,r.score+=s;const d={};d.classId=_.value,d.groupId=r.id,d.studentId=e,d.score=s,c(d).then((()=>{}),(()=>{t.score=n,r.score-=s,I.error("保存失败，请重试")}))}finally{delete w[e],C.value[e]=!1}};function O(){i({classId:_.value}).then((e=>{e&&(E.value=e.groups,M.value=1===e.needRoll)}))}return p((()=>{_.value=A.currentRoute.value.query.classId,O()})),(t,n)=>(v(),f("div",b,[g("div",G,[S(s,{students:x.value},null,8,["students"]),S(e,{groups:E.value,onGroupAdd:H,onGroupSubtract:U,onGroupScoreAdd:W,onGroupScoreSubtract:z,onStudentAdd:J,onStudentSubtract:K,onSetLeader:q,onStartEditingScore:L,onEndEditingScore:V},null,8,["groups"])]),g("div",R,[S(o,{groups:k.value},null,8,["groups"]),S(r,{students:x.value},null,8,["students"])])]))}},[["__scopeId","data-v-8b4853d6"]]);export{E as default};
